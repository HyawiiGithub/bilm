<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CineNova ðŸ’œ - Movie Viewer</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0a0a0a" />

  <link rel="manifest" href="../manifest.json" />
  <link rel="apple-touch-icon" href="../icon.png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #f0f0f0;
      overflow-x: hidden;
    }
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    #playerWrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
      width: 800px;
      max-width: 95vw;
      position: relative;
    }

    #playerContainer {
      width: 100%;
      aspect-ratio: 16 / 9;
      background-color: black;
      border-radius: 12px;
      box-shadow: 0 0 15px #a14effaa;
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

      iframe
      width: 100%;
      height: 100%;
        allowfullscreen
        allow="autoplay; fullscreen; encrypted-media"
      position: relative;
      z-index: 1;
    }

    #fullscreenBtn {
      margin-top: 12px;
      background-color: #3a1361;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
      max-width: 120px;
      text-align: center;
      user-select: none;
      z-index: 20;
      position: relative;
    }

    #fullscreenBtn:hover {
      background-color: #a855f7;
    }

    #closeBtn {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      z-index: 100;
      background: transparent;
      color: white;
      border: none;
      width: 48px;
      height: 48px;
      font-size: 20px;
      cursor: pointer;
      font-weight: 700;
      text-align: center;
      line-height: 48px;
      border-radius: 0;
    }

    #clickShield {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 5;
      pointer-events: auto; /* intercept clicks by default to prevent accidental ad-click-through */
      background: transparent;
    }

    #shieldControls {
      position: absolute;
      right: 8px;
      bottom: 8px;
      display: flex;
      gap: 8px;
      z-index: 20;
      align-items: center;
    }

    .shieldBtn {
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 6px 8px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      backdrop-filter: blur(4px);
      font-size: 13px;
    }

    #serverList {
      position: absolute;
      left: 100%;
      margin-left: 20px;
      top: 0;
      width: 140px;
      color: #ddd;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px;
      background: rgba(26, 22, 40, 0.9);
      border-radius: 12px;
      box-shadow: 0 0 15px #a14effaa;
      max-height: 300px;
      overflow-y: auto;
      z-index: 10;
    }

    #serverList h2 {
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 1.1rem;
      color: #a14eff;
      text-align: center;
    }

    .serverBtn {
      background-color: #3a1361;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
      width: 100%;
      text-align: center;
      user-select: none;
      white-space: nowrap;
    }

    .serverBtn:hover {
      background-color: #a855f7;
    }

    .serverBtn.active {
      background-color: #a14eff;
      cursor: default;
    }

    .simulated-fullscreen {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 99;
      border-radius: 0 !important;
    }

    .hide-navbar {
      display: none !important;
    }
  </style>
</head>
<body>

<div id="navbarContainer"></div>

<main>
  <div id="playerWrapper">
    <div id="playerContainer">
      <iframe
        id="videoPlayer"
        src=""
        title="Movie player"
        allowfullscreen
        allow="fullscreen; encrypted-media"
        sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock"
        playsinline
        scrolling="no"
      ></iframe>
      <div id="clickShield" aria-hidden="true"></div>
      <div id="shieldControls" aria-hidden="false">
        <div class="shieldBtn" id="shieldStatus">Ad clicks blocked</div>
        <button class="shieldBtn" id="shieldToggle">Enable player</button>
      </div>
    </div>
    <button id="fullscreenBtn">Fullscreen</button>
    <button id="closeBtn">X</button>

    <div id="playerControls" style="margin-top:12px; display:flex; gap:8px; justify-content:center; align-items:center;">
      <div id="playerStatus" aria-live="polite" style="color:#ddd; font-weight:600">Loading playerâ€¦</div>
      <button id="playOnSiteBtn" class="serverBtn" style="padding:6px 10px; font-size:13px;">Play on site</button>
      <button id="openProviderBtn" class="serverBtn" style="padding:6px 10px; font-size:13px;">Open provider</button>
      <button id="tryNextBtn" class="serverBtn" style="padding:6px 10px; font-size:13px;">Try next server</button>
    </div>

    <div id="serverList">
      <h2>Servers</h2>
      <button class="serverBtn active" id="serverVidsrc">VidSrc</button>
      <button class="serverBtn" id="serverVidplay">VidPlay</button>
    </div>
  </div>
</main>

<script>
  const params = new URLSearchParams(window.location.search);
  const movieId = params.get('id');

  const iframe = document.getElementById('videoPlayer');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const closeBtn = document.getElementById('closeBtn');
  const playerContainer = document.getElementById('playerContainer');
  const navbarContainer = document.getElementById('navbarContainer');

  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  const servers = {
    vidsrc: document.getElementById('serverVidsrc'),
    vidplay: document.getElementById('serverVidplay')
  };

  const openProviderBtn = document.getElementById('openProviderBtn');
  const tryNextBtn = document.getElementById('tryNextBtn');
  const playOnSiteBtn = document.getElementById('playOnSiteBtn');
  const playerStatus = document.getElementById('playerStatus');

  function loadServer(server) {
    if (!movieId) {
      console.error('No movie ID provided.');
      playerStatus.textContent = 'No movie id provided â€” open movie from the list or append ?id=... in URL.';
      iframe.src = '';
      return;
    }

    let url = '';
    switch (server) {
      case 'vidsrc':
        url = `https://vidsrc.xyz/embed/movie/${movieId}`;
        break;
      case 'vidplay':
        url = `https://vidplay.to/movie/${movieId}`;
        break;
      default:
        url = '';
    }
    iframe.src = url;
    playerStatus.textContent = 'Loading ' + server + ' ...';
  }

  function setActive(serverKey) {
    Object.keys(servers).forEach(key => {
      if (key === serverKey) servers[key].classList.add('active');
      else servers[key].classList.remove('active');
    });
  }

  Object.entries(servers).forEach(([key, btn]) => {
    btn.addEventListener('click', () => {
      if (btn.classList.contains('active')) return;
      setActive(key);
      loadServer(key);
    });
  });

  setActive('vidsrc');
  loadServer('vidsrc');

  // 'Open provider' opens current embed src in a new tab
  openProviderBtn.addEventListener('click', () => {
    if (!iframe.src) {
      playerStatus.textContent = 'No provider loaded â€” select a server first';
      return;
    }
    window.open(iframe.src, '_blank');
  });

  // 'Try next' rotates through available server keys
  const serverKeys = Object.keys(servers);
  tryNextBtn.addEventListener('click', () => {
    const current = serverKeys.findIndex(k => servers[k].classList.contains('active'));
    const next = serverKeys[(current + 1) % serverKeys.length];
    setActive(next);
    loadServer(next);
  });

  // Play on site logic: checks for hosted media under /media/movie/<movieId> or /media/movie/<movieId>.m3u8/.mp4
  // Robust on-site existence check: try HEAD, then fall back to a small GET using Range
  async function existsHeadOrRange(url) {
    try {
      // First try a HEAD request
      const headRes = await fetch(url, { method: 'HEAD' });
      if (headRes && headRes.ok) return true;
    } catch (e) {
      // ignore
    }

    // Fall back to GET for a 1-byte range to avoid fetching full file
    try {
      const getRes = await fetch(url, { method: 'GET', headers: { 'Range': 'bytes=0-0' } });
      if (getRes && (getRes.status === 206 || getRes.status === 200)) return true;
    } catch (e) {
      // ignore
    }
    return false;
  }

  async function checkOnSitePaths() {
    const basePrefix = (location.pathname.split('/').filter(Boolean)[0] === 'cinenova') ? '/cinenova' : '';
    // We try relative to the site root or /cinenova if deployed there
    const candidates = [
      `${basePrefix}/media/movie/${movieId}/master.m3u8`,
      `${basePrefix}/media/movie/${movieId}/index.m3u8`,
      `${basePrefix}/media/movie/${movieId}.m3u8`,
      `${basePrefix}/media/movie/${movieId}.mp4`,
      `${basePrefix}/media/movie/${movieId}/video.mp4`
    ];

    for (const url of candidates) {
      try {
        // quick debug log
        console.debug('[playOnSite] checking', url);
        if (await existsHeadOrRange(url)) return url;
      } catch (err) {
        console.debug('[playOnSite] error checking', url, err);
      }
    }
    return null;
  }

  async function playOnSite() {
    if (!movieId) return;
    playerStatus.textContent = 'Checking on-site files...';
    const url = await checkOnSitePaths();
    if (!url) {
      playerStatus.textContent = 'No on-site copy found â€” falling back to provider';
      return;
    }

    // Replace iframe with native video player
    const video = document.createElement('video');
    video.controls = true;
    video.autoplay = true;
    video.style.width = '100%';
    video.style.height = '100%';
    video.style.borderRadius = '12px';
    video.id = 'sitePlayer';

    // If HLS (.m3u8) try to use Hls.js when needed
    if (url.endsWith('.m3u8')) {
      // prefer browser native HLS where available
      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
      } else {
        // use HLS.js (load from CDN if not already loaded)
        if (!window.Hls) {
          await new Promise((resolve) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/hls.js@1.3.6/dist/hls.min.js';
            s.onload = resolve;
            document.head.appendChild(s);
          });
        }
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
      }
    } else {
      video.src = url; // mp4 fallback
    }

    // Swap elements
    const parent = iframe.parentElement;
    iframe.style.display = 'none';
    parent.insertBefore(video, iframe);
    playerStatus.textContent = 'Playing on site â€” enjoy!';
  }

  playOnSiteBtn.addEventListener('click', playOnSite);

  // Auto-detect on-site availability on load and enable/disable button
  (async function autoDetectOnSite() {
    try {
      playOnSiteBtn.disabled = true;
      const url = await checkOnSitePaths();
      if (url) {
        playOnSiteBtn.disabled = false;
        playOnSiteBtn.dataset.foundUrl = url;
        playerStatus.textContent = 'Local copy available â€” click "Play on site" to play it.';
      } else {
        playOnSiteBtn.disabled = false; // keep enabled so user can still attempt a manual check
      }
    } catch (err) {
      console.debug('[playOnSite] autodetect failed', err);
      playOnSiteBtn.disabled = false;
    }
  })();

  fullscreenBtn.onclick = () => {
    if (!isMobile) {
      if (playerContainer.requestFullscreen) {
        playerContainer.requestFullscreen();
      } else if (playerContainer.webkitRequestFullscreen) {
        playerContainer.webkitRequestFullscreen();
      } else if (playerContainer.msRequestFullscreen) {
        playerContainer.msRequestFullscreen();
      }
    } else {
      playerContainer.classList.add('simulated-fullscreen');
    }
    closeBtn.style.display = 'block';
    navbarContainer.classList.add('hide-navbar');
  };

  closeBtn.onclick = () => {
    if (isMobile) {
      playerContainer.classList.remove('simulated-fullscreen');
    } else if (document.fullscreenElement || document.webkitFullscreenElement) {
      document.exitFullscreen?.() || document.webkitExitFullscreen?.();
    }
    closeBtn.style.display = 'none';
    navbarContainer.classList.remove('hide-navbar');
  };

  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      closeBtn.style.display = 'none';
      navbarContainer.classList.remove('hide-navbar');
    }
  });
  // ----- Anti-click-ad shield -----
  (function () {
    const clickShield = document.getElementById('clickShield');
    const shieldToggle = document.getElementById('shieldToggle');
    const shieldStatus = document.getElementById('shieldStatus');

    let shieldOn = true;

    function setShield(on) {
      shieldOn = on;
      if (on) {
        clickShield.style.pointerEvents = 'auto';
        shieldStatus.textContent = 'Ad clicks blocked';
        shieldToggle.textContent = 'Enable player';
      } else {
        clickShield.style.pointerEvents = 'none';
        shieldStatus.textContent = 'Player interactive';
        shieldToggle.textContent = 'Disable player';
      }
    }

    // Catch and neutralize accidental clicks/contextmenu on the iframe
    clickShield.addEventListener('click', e => {
      if (!shieldOn) return;
      e.preventDefault();
      e.stopPropagation();
      shieldStatus.textContent = 'Blocked ad-click â€” click "Enable player" to interact';
      setTimeout(() => shieldStatus.textContent = 'Ad clicks blocked', 2200);
    });

    clickShield.addEventListener('auxclick', e => {
      if (!shieldOn) return;
      e.preventDefault();
      e.stopPropagation();
    });

    clickShield.addEventListener('contextmenu', e => {
      if (!shieldOn) return;
      e.preventDefault();
      e.stopPropagation();
    });

    shieldToggle.addEventListener('click', () => setShield(!shieldOn));

    // Initial state: OFF (interactive) â€” allow provider embeds to behave as before
    setShield(false);
    // If iframe loads we show a basic status (we can't inspect cross-origin contents)
    iframe.addEventListener('load', () => {
      if (!iframe.src) {
        playerStatus.textContent = 'No provider loaded';
        return;
      }
      playerStatus.textContent = 'Player loaded â€” if the player shows "unavailable" try "Try next server" or "Open provider".';
    });
  })();
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const basePrefix = (location.pathname.split('/').filter(Boolean)[0] === 'cinenova') ? '/cinenova' : '';
    fetch(`${basePrefix}/shared/navbar.html`)
      .then(res => res.text())
      .then(html => {
        document.getElementById('navbarContainer').innerHTML = html;
        const css = document.createElement('link');
        css.rel = 'stylesheet';
        css.href = `${basePrefix}/shared/navbar.css`;
        document.head.appendChild(css);
        const script = document.createElement('script');
        script.src = `${basePrefix}/shared/navbar.js`;
        document.body.appendChild(script);
      });
  });
</script>

<script>
  // Dynamically load adblock script using the same basePrefix used above
  (function(){
    const basePrefix = (location.pathname.split('/').filter(Boolean)[0] === 'cinenova') ? '/cinenova' : '';
    const s = document.createElement('script');
    s.src = `${basePrefix}/shared/adblock/adblock.js`;
    document.body.appendChild(s);
  })();
</script>

</body>
</html>
